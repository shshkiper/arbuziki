# Настройка базы данных Supabase для приложения Drink with Book

## Шаги настройки

### 1. Создание проекта в Supabase
1. Зайдите на [supabase.com](https://supabase.com)
2. Создайте новый аккаунт или войдите в существующий
3. Нажмите "New Project"
4. Выберите организацию и введите название проекта: `drink-with-book`
5. Создайте надежный пароль для базы данных
6. Выберите регион (желательно ближайший к вашим пользователям)
7. Дождитесь создания проекта (обычно 1-2 минуты)

### 2. Получение ключей доступа
После создания проекта:
1. Перейдите в Settings → API
2. Скопируйте:
   - **Project URL** (например: `https://xxx.supabase.co`)
   - **Anon public key** (начинается с `eyJ...`)

### 3. Настройка файла .env
В корне проекта `drinkwithbook` создайте или обновите файл `.env`:

```env
SUPABASE_URL=ваш_project_url_здесь
SUPABASE_ANON_KEY=ваш_anon_key_здесь
```

### 4. Выполнение SQL скриптов

#### 4.1. Создание схемы базы данных
1. В панели Supabase перейдите в SQL Editor
2. Создайте новый запрос
3. Скопируйте содержимое файла `supabase_schema.sql`
4. Вставьте в редактор и нажмите "Run"

#### 4.2. Заполнение начальными данными
1. Создайте еще один новый запрос в SQL Editor
2. Скопируйте содержимое файла `supabase_seed_data.sql`
3. Вставьте в редактор и нажмите "Run"

### 5. Настройка аутентификации

#### 5.1. Базовые настройки
1. Перейдите в Authentication → Settings
2. Включите следующие провайдеры:
   - Email (уже включен по умолчанию)
   - Google (опционально)
   - Apple (опционально)

#### 5.2. Email шаблоны (опционально)
Вы можете настроить кастомные шаблоны писем в Authentication → Email Templates

### 6. Настройка Storage (для изображений)

#### 6.1. Создание bucket'а
1. Перейдите в Storage
2. Создайте новый bucket с именем `images`
3. Сделайте его публичным для чтения

#### 6.2. Политики доступа
```sql
-- Разрешить всем читать изображения
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING (bucket_id = 'images');

-- Разрешить авторизованным пользователям загружать изображения
CREATE POLICY "Authenticated users can upload" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'images' AND auth.role() = 'authenticated');
```

### 7. Проверка настроек

#### 7.1. Проверка таблиц
В SQL Editor выполните:
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

Должны появиться все таблицы из схемы.

#### 7.2. Проверка данных
```sql
-- Проверить категории
SELECT * FROM categories;

-- Проверить продукты
SELECT COUNT(*) FROM products;

-- Проверить клубы
SELECT * FROM clubs;
```

### 8. Настройка RLS (Row Level Security)

Все необходимые политики RLS уже включены в `supabase_schema.sql`. Они обеспечивают:
- Пользователи видят только свои данные
- Публичный доступ к продуктам и клубам
- Безопасность чатов и транзакций

### 9. Тестирование подключения

После выполнения всех шагов запустите приложение:

```bash
cd drinkwithbook
flutter pub get
flutter run
```

## Структура базы данных

### Основные таблицы:

- **profiles** - профили пользователей
- **categories** - категории товаров  
- **products** - товары (кофе, чай, десерты, книги)
- **orders** / **order_items** - заказы и их позиции
- **clubs** / **club_members** - клубы и участники
- **club_events** / **event_attendees** - события клубов
- **club_posts** / **post_comments** - посты и комментарии
- **subscriptions** - подписки пользователей
- **loyalty_transactions** - транзакции программы лояльности
- **rewards** / **user_rewards** - награды и их использование
- **chat_messages** - сообщения чатов
- **favorites** - избранные товары

### Ключевые функции:

- **add_loyalty_points()** - начисление баллов лояльности
- **spend_loyalty_points()** - списание баллов
- **handle_new_user()** - автоматическое создание профиля
- **update_updated_at_column()** - обновление временных меток

### Представления (Views):

- **club_stats** - статистика по клубам
- **user_loyalty_stats** - статистика лояльности пользователей  
- **popular_products** - популярные товары

## Возможные проблемы и решения

### Ошибка "relation does not exist"
- Убедитесь, что выполнили `supabase_schema.sql` полностью
- Проверьте, что все таблицы созданы в схеме `public`

### Ошибка доступа к данным
- Проверьте настройки RLS
- Убедитесь, что пользователь авторизован

### Медленные запросы
- Все необходимые индексы уже созданы в схеме
- При большой нагрузке рассмотрите возможность добавления дополнительных индексов

## Мониторинг и обслуживание

### Просмотр логов
- Перейдите в Logs в панели Supabase
- Мониторьте медленные запросы и ошибки

### Резервное копирование
- Supabase автоматически создает резервные копии
- Для критических данных настройте дополнительное резервирование

### Обновления схемы
При необходимости изменения схемы:
1. Создайте миграционный SQL скрипт
2. Протестируйте на копии данных
3. Выполните в продакшене в периоды низкой нагрузки

## Безопасность

- Никогда не передавайте service_role ключ в клиентское приложение
- Используйте только anon/public ключи в мобильном приложении
- Все чувствительные операции защищены RLS политиками
- Регулярно проверяйте логи на подозрительную активность
